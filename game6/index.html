<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ASTRO FARMER - REFINED</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #050510;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.2);
            border: 4px solid #444;
            background: #000;
        }

        /* „Éñ„É©„Ç¶„É≥ÁÆ°„ÅÆ„Çπ„Ç≠„É£„É≥„É©„Ç§„É≥ÊºîÂá∫ */
        #game-container::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
        }

        canvas { display: block; }

        #ui {
            position: absolute;
            top: 15px;
            left: 15px;
            pointer-events: none;
            z-index: 20;
            text-shadow: 2px 2px #000;
        }

        .label { font-size: 12px; color: #0ff; margin-bottom: 2px; }
        .value { font-size: 20px; font-weight: bold; margin-bottom: 15px; letter-spacing: 2px; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas" width="500" height="700"></canvas>
    <div id="ui">
        <div class="label">HI-SCORE</div>
        <div id="hi-score" class="value" style="color:#ffcc00">000000</div>
        <div class="label">SCORE</div>
        <div id="score" class="value">000000</div>
        <div class="label">SHIELD</div>
        <div id="shield-count" class="value">NONE</div>
        <div class="label">WEAPON</div>
        <div id="power-level" class="value">Lv.1</div>
    </div>
</div>

<script>
/* =========================================
   1. „Ç≤„Éº„É†Ë®≠ÂÆö„Å®ÂÆöÊï∞
   ========================================= */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const CONFIG = {
    MAX_SHIELD: 3,
    MAX_POWER: 3,
    PLAYER_SPEED: 5,
    BULLET_W: 4,
    BULLET_H: 12
};

let gameState = 'START';
let score = 0;
let hiScore = localStorage.getItem('astroFarmerHiScore') || 0;
let frames = 0;
let difficulty = 1;

// ÂÖ•ÂäõÁÆ°ÁêÜ
const keys = {};
window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => keys[e.code] = false);

// „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜÁî®ÈÖçÂàó
let player, enemies, enemyBullets, playerBullets, items, particles, stars;

/* =========================================
   2. „ÇØ„É©„ÇπÂÆöÁæ©
   ========================================= */

// --- Ëá™Ê©ü„ÇØ„É©„Çπ ---
class Player {
    constructor() {
        this.w = 30;
        this.h = 35;
        this.x = canvas.width / 2 - this.w / 2;
        this.y = canvas.height - 80;
        this.shield = 0;
        this.power = 1;
        this.invincible = 0;
        this.shotTimer = 0;
    }

    update() {
        // ÁßªÂãï
        if (keys.ArrowLeft && this.x > 0) this.x -= CONFIG.PLAYER_SPEED;
        if (keys.ArrowRight && this.x < canvas.width - this.w) this.x += CONFIG.PLAYER_SPEED;
        if (keys.ArrowUp && this.y > 0) this.y -= CONFIG.PLAYER_SPEED;
        if (keys.ArrowDown && this.y < canvas.height - this.h) this.y += CONFIG.PLAYER_SPEED;

        if (this.invincible > 0) this.invincible--;

        // Ëá™ÂãïÂ∞ÑÊíÉ
        this.shotTimer++;
        const interval = this.power === 3 ? 7 : 10;
        if (this.shotTimer >= interval) {
            this.shoot();
            this.shotTimer = 0;
        }
    }

    shoot() {
        const bx = this.x + this.w / 2;
        if (this.power === 1) {
            playerBullets.push(new PlayerBullet(bx, this.y, 0));
        } else if (this.power === 2) {
            playerBullets.push(new PlayerBullet(bx - 10, this.y, 0));
            playerBullets.push(new PlayerBullet(bx + 10, this.y, 0));
        } else {
            playerBullets.push(new PlayerBullet(bx, this.y, 0));
            playerBullets.push(new PlayerBullet(bx - 15, this.y, -1.5));
            playerBullets.push(new PlayerBullet(bx + 15, this.y, 1.5));
        }
    }

    draw() {
        if (this.invincible % 10 < 5) {
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.moveTo(this.x + this.w / 2, this.y);
            ctx.lineTo(this.x, this.y + this.h);
            ctx.lineTo(this.x + this.w, this.y + this.h);
            ctx.fill();
        }
        // „Ç∑„Éº„É´„Éâ„Ç®„Éï„Çß„ÇØ„Éà
        if (this.shield > 0) {
            ctx.strokeStyle = '#0ff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(this.x + this.w / 2, this.y + this.h / 2, 30, 0, Math.PI * 2);
            ctx.stroke();
        }
    }
}

// --- Ëá™Ê©ü„ÅÆÂºæ„ÇØ„É©„Çπ ---
class PlayerBullet {
    constructor(x, y, dx) {
        this.x = x - CONFIG.BULLET_W / 2;
        this.y = y;
        this.w = CONFIG.BULLET_W; // Âà§ÂÆö„Å´ÂøÖË¶Å
        this.h = CONFIG.BULLET_H; // Âà§ÂÆö„Å´ÂøÖË¶Å
        this.dx = dx;
        this.dy = -12;
    }
    update() {
        this.x += this.dx;
        this.y += this.dy;
    }
    draw() {
        ctx.fillStyle = '#ff0';
        ctx.fillRect(this.x, this.y, this.w, this.h);
    }
}

// --- Êïµ„ÇØ„É©„Çπ ---
class Enemy {
    constructor() {
        this.w = 30;
        this.h = 30;
        this.x = Math.random() * (canvas.width - this.w);
        this.y = -40;
        // Èõ£ÊòìÂ∫¶„Å´Âøú„Åò„Å¶ÈÄüÂ∫¶„Ç¢„ÉÉ„Éó
        this.speedY = 2 + (difficulty * 0.4);
    }
    update() {
        this.y += this.speedY;
        // Èõ£ÊòìÂ∫¶„Å´Âøú„Åò„Å¶Áô∫Â∞ÑÈ†ªÂ∫¶„Ç¢„ÉÉ„Éó
        const shootChance = Math.max(20, 80 - (difficulty * 6));
        if (frames % shootChance === 0) this.shoot();
    }
    shoot() {
        const bx = this.x + this.w / 2;
        const by = this.y + this.h;
        // Èõ£ÊòìÂ∫¶„Åå‰∏ä„Åå„Çã„Å®Ëá™Ê©ü„ÇíÁãô„ÅÜÂºæ„ÇíÊíÉ„Å§
        if (difficulty >= 4 && Math.random() < 0.3 + (difficulty * 0.05)) {
            const angle = Math.atan2(player.y - by, player.x - bx);
            enemyBullets.push(new EnemyBullet(bx, by, angle));
        } else {
            enemyBullets.push(new EnemyBullet(bx, by, Math.PI / 2));
        }
    }
    draw() {
        ctx.fillStyle = (difficulty > 5) ? '#ff0055' : '#ff4444';
        ctx.fillRect(this.x, this.y, this.w, this.h);
        // ÁõÆ
        ctx.fillStyle = '#000';
        ctx.fillRect(this.x + 6, this.y + 8, 4, 4);
        ctx.fillRect(this.x + 20, this.y + 8, 4, 4);
    }
}

// --- Êïµ„ÅÆÂºæ„ÇØ„É©„Çπ ---
class EnemyBullet {
    constructor(x, y, angle) {
        this.x = x;
        this.y = y;
        const speed = 4 + (difficulty * 0.5); // Èõ£ÊòìÂ∫¶„ÅßÂºæÈÄü„Ç¢„ÉÉ„Éó
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
        this.r = 5;
    }
    update() {
        this.x += this.vx;
        this.y += this.vy;
    }
    draw() {
        ctx.fillStyle = '#f0f';
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#fff'; // ‰∏≠ÂøÉ„ÇíÁôΩ„Åè„Åó„Å¶Ëºù„Åã„Åõ„Çã
        ctx.beginPath();
        ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
        ctx.fill();
    }
}

// --- „Ç¢„Ç§„ÉÜ„É†„ÇØ„É©„Çπ ---
class Item {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.type = Math.random() < 0.5 ? 'S' : 'P';
        this.w = 25;
        this.h = 25;
    }
    update() { this.y += 2; }
    draw() {
        ctx.fillStyle = (this.type === 'S') ? '#0ff' : '#f44';
        ctx.fillRect(this.x, this.y, this.w, this.h);
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.font = 'bold 16px Arial';
        ctx.fillText(this.type, this.x + 12, this.y + 19);
    }
}

// --- ÁàÜÁô∫„Ç®„Éï„Çß„ÇØ„Éà ---
class Particle {
    constructor(x, y, color) {
        this.x = x; this.y = y;
        this.vx = (Math.random() - 0.5) * 10;
        this.vy = (Math.random() - 0.5) * 10;
        this.life = 1.0;
        this.color = color;
    }
    update() { this.x += this.vx; this.y += this.vy; this.life -= 0.04; }
    draw() {
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.fillRect(this.x, this.y, 3, 3);
        ctx.globalAlpha = 1.0;
    }
}

/* =========================================
   3. „Ç≤„Éº„É†„Ç∑„Çπ„ÉÜ„É†„Éª„É≠„Ç∏„ÉÉ„ÇØ
   ========================================= */

function resetGame() {
    player = new Player();
    enemies = []; enemyBullets = []; playerBullets = [];
    items = []; particles = [];
    score = 0; frames = 0; difficulty = 1;
    gameState = 'PLAYING';
    updateUI();
}

function updateUI() {
    document.getElementById('score').innerText = score.toString().padStart(6, '0');
    document.getElementById('hi-score').innerText = hiScore.toString().padStart(6, '0');
    document.getElementById('shield-count').innerText = "üõ°Ô∏è".repeat(player.shield) || "NONE";
    document.getElementById('power-level').innerText = "Lv." + player.power;
}

function handleHit() {
    if (player.shield > 0) {
        player.shield--;
        player.invincible = 90;
        // Ë¢´Âºæ„Ç®„Éï„Çß„ÇØ„Éà
        for(let k=0; k<15; k++) particles.push(new Particle(player.x + 15, player.y + 15, '#0ff'));
        updateUI();
    } else {
        if (score > hiScore) {
            hiScore = score;
            localStorage.setItem('astroFarmerHiScore', hiScore);
        }
        gameState = 'GAMEOVER';
        setTimeout(() => gameState = 'WAITING', 2000);
    }
}

function update() {
    if (gameState !== 'PLAYING') return;

    frames++;
    difficulty = 1 + Math.floor(score / 2000); // 2000ÁÇπ„Åî„Å®„Å´„É¨„Éô„É´„Ç¢„ÉÉ„Éó

    player.update();
    
    // Ëá™Ê©üÂºæ„ÅÆÊõ¥Êñ∞
    playerBullets.forEach((b, i) => {
        b.update();
        if (b.y < -20) playerBullets.splice(i, 1);
    });

    // Êïµ„ÅÆÁô∫Áîü
    const spawnRate = Math.max(8, 60 - (difficulty * 4));
    if (frames % spawnRate === 0) enemies.push(new Enemy());

    // Êïµ„ÅÆÂá¶ÁêÜ
    enemies.forEach((e, i) => {
        e.update();
        if (e.y > canvas.height + 50) enemies.splice(i, 1);
        
        // ÂΩì„Åü„ÇäÂà§ÂÆö (ÂØæ Ëá™Ê©üÂºæ)
        playerBullets.forEach((pb, j) => {
            if (isColliding(pb, e)) {
                for(let k=0; k<8; k++) particles.push(new Particle(e.x+15, e.y+15, '#f44'));
                enemies.splice(i, 1);
                playerBullets.splice(j, 1);
                score += 100;
                if (Math.random() < 0.15) items.push(new Item(e.x, e.y));
                updateUI();
            }
        });

        // ÂΩì„Åü„ÇäÂà§ÂÆö (ÂØæ Ëá™Ê©üÊú¨‰Ωì)
        if (player.invincible === 0 && isColliding(player, e)) {
            handleHit();
            enemies.splice(i, 1);
        }
    });

    // ÊïµÂºæ„ÅÆÂá¶ÁêÜ
    enemyBullets.forEach((eb, i) => {
        eb.update();
        if (eb.y > canvas.height || eb.x < 0 || eb.x > canvas.width) enemyBullets.splice(i, 1);
        if (player.invincible === 0 && isCircleRectColliding(eb, player)) {
            handleHit();
            enemyBullets.splice(i, 1);
        }
    });

    // „Ç¢„Ç§„ÉÜ„É†ÂõûÂèé
    items.forEach((it, i) => {
        it.update();
        if (isColliding(player, it)) {
            if (it.type === 'S' && player.shield < CONFIG.MAX_SHIELD) player.shield++;
            else if (it.type === 'P' && player.power < CONFIG.MAX_POWER) player.power++;
            else score += 1000;
            items.splice(i, 1);
            updateUI();
        }
    });

    particles.forEach((p, i) => { p.update(); if (p.life <= 0) particles.splice(i, 1); });
}

/* =========================================
   4. ÊèèÁîª„ÉªÊºîÂá∫
   ========================================= */

function draw() {
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // ËÉåÊôØ„ÅÆÊòü
    ctx.fillStyle = '#444';
    if (!stars) {
        stars = Array.from({length: 50}, () => ({x:Math.random()*canvas.width, y:Math.random()*canvas.height, s:Math.random()*2}));
    }
    stars.forEach(s => {
        s.y += 1.5; if (s.y > canvas.height) s.y = 0;
        ctx.fillRect(s.x, s.y, s.s, s.s);
    });

    if (gameState === 'START') {
        drawOverlay("ASTRO FARMER v5", "PRESS SPACE TO START");
        if (keys.Space) resetGame();
    } else {
        player.draw();
        playerBullets.forEach(b => b.draw());
        enemies.forEach(e => e.draw());
        enemyBullets.forEach(eb => eb.draw());
        items.forEach(it => it.draw());
        particles.forEach(p => p.draw());

        if (gameState === 'GAMEOVER' || gameState === 'WAITING') {
            drawOverlay("GAME OVER", `FINAL SCORE: ${score.toString().padStart(6, '0')}`, (gameState === 'WAITING'));
            if (gameState === 'WAITING' && keys.Space) resetGame();
        }
    }
}

function drawOverlay(t1, t2, showRetry = true) {
    ctx.fillStyle = 'rgba(0,0,0,0.8)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#fff';
    ctx.textAlign = 'center';
    ctx.font = '28px "Courier New"';
    ctx.fillText(t1, canvas.width / 2, canvas.height / 2 - 20);
    ctx.fillStyle = '#0ff';
    ctx.font = '18px "Courier New"';
    ctx.fillText(t2, canvas.width / 2, canvas.height / 2 + 30);
    
    if (showRetry) {
        ctx.fillStyle = '#aaa';
        ctx.font = '14px "Courier New"';
        ctx.fillText("PRESS SPACE TO RETRY", canvas.width / 2, canvas.height / 2 + 80);
    }
}

// Âà§ÂÆö„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
function isColliding(a, b) {
    // ‰∏°Êñπ„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´ x, y, w, h „ÅåÂ≠òÂú®„Åô„Çã„Åì„Å®„ÇíÂâçÊèê„Å®„Åô„Çã
    return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
}
function isCircleRectColliding(c, r) {
    let x = Math.max(r.x, Math.min(c.x, r.x + r.w));
    let y = Math.max(r.y, Math.min(c.y, r.y + r.h));
    return ((x - c.x)**2 + (y - c.y)**2) < c.r**2;
}

function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
document.getElementById('hi-score').innerText = hiScore.toString().padStart(6, '0');
gameLoop();

</script>
</body>
</html>